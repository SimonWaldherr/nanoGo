<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>nanoGo ‚Äî Advanced WebAssembly Go Playground</title>
  <link rel="icon" href="assets/logo.svg">
  <style>
    :root {
      --bg: #0a0c10;
      --panel: #111418;
      --panel-light: #1a1e24;
      --panel-elevated: #1f2328;
      --text: #e6e8eb;
      --text-muted: #94a3b8;
      --text-dim: #64748b;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #1f242b;
      --border-light: #374151;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --code-bg: #0d1117;
      --glass-bg: rgba(17, 20, 24, 0.8);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* Smooth transitions when switching themes */
    html, body, .header, .panel, .editor-container, .output-panel, .examples-panel, .example-item, .theme-popup, .CodeMirror {
      transition: background-color 260ms ease, color 260ms ease, border-color 260ms ease, box-shadow 260ms ease;
    }

    /* Header */
    .header {
      background: var(--gradient-bg);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      font-size: 1.25rem;
    }

    .brand img {
      width: 32px;
      height: 32px;
    }

    .brand-subtitle {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.875rem;
      margin-left: 0.5rem;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    /* Main Layout */
    .main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      grid-template-columns: 300px 1fr 400px;
      gap: 2rem;
      min-height: calc(100vh - 120px);
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .examples-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .panel-header {
      background: var(--panel-light);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.25rem;
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .examples-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .example-search {
      display: block;
      width: calc(100% - 24px);
      margin: 0.75rem 1.25rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      outline: none;
    }

    .copy-btn {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-muted);
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .copy-btn:hover { color: var(--text); background: var(--panel-light); }

    .tag-filters { display:flex; gap:8px; padding:0.5rem 1.25rem; flex-wrap:wrap }
    .tag-btn {
      background: var(--panel-elevated);
      color: var(--text-muted);
      border: 1px solid var(--border);
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .tag-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* Theme popup */
    .theme-popup {
      position: absolute;
      right: 0.5rem;
      top: 3rem;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      padding: 0.5rem;
      z-index: 200;
      min-width: 220px;
      display: none;
    }
    .theme-popup[aria-hidden="false"] { display: block; }
    .theme-popup-grid { display:flex; flex-wrap:wrap; gap:8px; }
    .theme-option { flex: 1 1 45%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel-elevated); color:var(--text); cursor:pointer; font-size:0.9rem; display:flex; gap:10px; align-items:center }
    .theme-option:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    .theme-option .swatch { width:36px; height:22px; border-radius:6px; border:2px solid rgba(255,255,255,0.06); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.15); flex: 0 0 auto }
    .theme-option .label { font-size:0.85rem; color:var(--text); flex:1 1 auto; text-align:left }
    .theme-option[aria-pressed="true"] { outline: 2px solid var(--accent); }
    .theme-option:focus { outline: 3px solid var(--accent); transform: translateY(-2px); }
    .theme-option.focused { box-shadow: 0 6px 18px rgba(0,0,0,0.35); }


    .example-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      color: var(--text);
    }

    .example-item:hover {
      background: var(--panel-light);
    }

    .example-item.active {
      background: var(--accent);
      color: white;
    }

    .example-item:last-child {
      border-bottom: none;
    }

    .example-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .example-name {
      font-weight: 500;
      font-size: 0.875rem;
    }

    .example-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .example-item.active .example-desc {
      color: rgba(255, 255, 255, 0.8);
    }

    .example-badge {
      background: var(--panel-elevated);
      color: var(--text-muted);
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .example-item.active .example-badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* Editor Section */
    .editor-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
    }

    .status.loading {
      color: var(--warning);
    }

    .status.ready {
      color: var(--success);
    }

    .status.error {
      color: var(--error);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status.loading .status-indicator {
      background: var(--warning);
    }

    .status.ready .status-indicator {
      background: var(--success);
    }

    .status.error .status-indicator {
      background: var(--error);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    /* Buttons and Inputs */
    button, select, input[type="number"] {
      background: var(--panel-light);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    button:hover, select:hover {
      background: var(--border-light);
      border-color: var(--accent);
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      font-weight: 500;
    }

    button.primary:hover {
      background: var(--accent-hover);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    /* Editor */
    .editor-container {
      position: relative;
      flex: 1;
      min-height: 500px;
    }

    #src {
      width: 100%;
      height: 100%;
      min-height: 500px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      background: var(--code-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      resize: none;
      outline: none;
      transition: border-color 0.2s ease;
    }

    #src:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* Output Section */
    .output-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .output-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      display: none;
    }

    .output-panel.active {
      display: block;
    }

    .output-header {
      background: var(--panel-light);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.25rem;
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .output-content {
      padding: 1.25rem;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* Canvas Output */
    .canvas-container {
      text-align: center;
      background: var(--code-bg);
      border-radius: 8px;
      padding: 1rem;
    }

    #life {
      max-width: 100%;
      height: auto;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: var(--code-bg);
      image-rendering: pixelated;
    }

    /* Console Output */
    #log {
      background: var(--code-bg);
      color: var(--text);
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.4;
      margin: 0;
      padding: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-y: auto;
      flex: 1;
      position: relative;
      border-radius: 8px;
      padding: 1rem;
    }

    .log-line {
      display: block;
      transition: opacity 0.3s ease;
      opacity: 1;
    }

    .log-line.fading {
      opacity: 0.3;
    }

    .log-line.old {
      opacity: 0.15;
    }

    #log:focus .log-line,
    #log.focused .log-line {
      opacity: 1 !important;
    }

    #log.auto-scroll {
      scroll-behavior: smooth;
    }

    /* DOM Output */
    #output {
      min-height: 100px;
      background: var(--code-bg);
      border-radius: 8px;
      padding: 1rem;
    }

    /* Info Panel */
    .info-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem;
      margin-top: auto;
    }

    .info-title {
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      color: var(--accent);
      font-size: 0.875rem;
    }

    .info-content {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .info-content ul {
      margin: 0.5rem 0;
      padding-left: 1.25rem;
    }

    .info-content li {
      margin-bottom: 0.25rem;
    }

    .info-content code {
      background: var(--code-bg);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
      .main {
        grid-template-columns: 280px 1fr 350px;
      }
    }

    @media (max-width: 1200px) {
      .main {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .sidebar {
        order: 2;
      }
      
      .output-section {
        order: 3;
      }
    }

    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
      }

      .main {
        padding: 1rem;
      }

      #src {
        min-height: 300px;
      }
    }

    /* Light Theme */
    .light {
      --bg: #ffffff;
      --panel: #f8fafc;
      --panel-light: #f1f5f9;
      --panel-elevated: #e2e8f0;
      --text: #0f172a;
      --text-muted: #475569;
      --text-dim: #64748b;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
      --code-bg: #ffffff;
      --gradient-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --glass-bg: rgba(248, 250, 252, 0.8);
      --glass-border: rgba(0, 0, 0, 0.1);
    }

    /* Additional themes */
    .theme-dark { /* default: same as base */ }
    .theme-solar {
      --bg: #fdf6e3;
      --panel: #f6eedb;
      --panel-light: #f0e8cf;
      --panel-elevated: #efe6c8;
      --text: #586e75;
      --text-muted: #657b83;
      --text-dim: #708284;
      --border: #e6dbc4;
      --border-light: #d6cbb3;
      --code-bg: #f8f2df;
      --gradient-bg: linear-gradient(135deg, #f8f2df 0%, #efe6c8 100%);
    }
    .theme-high-contrast {
      --bg: #000000;
      --panel: #000000;
      --panel-light: #0a0a0a;
      --panel-elevated: #111111;
      --text: #ffffff;
      --text-muted: #f3f3f3;
      --text-dim: #e6e6e6;
      --accent: #ffff00;
      --accent-hover: #ffd400;
      --border: #444400;
      --border-light: #666600;
      --code-bg: #000000;
      --gradient-bg: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
    }
    .theme-dracula {
      --bg: #282a36;
      --panel: #44475a;
      --panel-light: #373844;
      --panel-elevated: #3b3f58;
      --text: #f8f8f2;
      --text-muted: #bfbfbf;
      --accent: #ff79c6;
      --border: #3b3f58;
      --code-bg: #21222c;
      --gradient-bg: linear-gradient(135deg,#282a36 0%,#373844 100%);
    }
    .theme-sepia {
      --bg: #f4ecd8;
      --panel: #efe6cf;
      --panel-light: #e9dfc6;
      --panel-elevated: #e3d7b8;
      --text: #2b2b21;
      --text-muted: #67604f;
      --accent: #b76e11;
      --border: #e0d6be;
      --code-bg: #f7f2df;
      --gradient-bg: linear-gradient(135deg,#f7f2df 0%,#efe6cf 100%);
    }
    .theme-monokai {
      --bg: #272822;
      --panel: #2b2b2b;
      --panel-light: #323232;
      --panel-elevated: #3a3a3a;
      --text: #f8f8f2;
      --text-muted: #a0a0a0;
      --accent: #a6e22e;
      --border: #333333;
      --code-bg: #2a2a2a;
      --gradient-bg: linear-gradient(135deg,#272822 0%,#323232 100%);
    }
    .theme-ocean {
      --bg: #052f4a;
      --panel: #073848;
      --panel-light: #0a4456;
      --panel-elevated: #074b60;
      --text: #e6f3f7;
      --text-muted: #bcdbe4;
      --accent: #2dd4bf;
      --border: #0b556a;
      --code-bg: #042733;
      --gradient-bg: linear-gradient(135deg,#052f4a 0%,#074b60 100%);
    }
    .theme-forest {
      --bg: #06220f;
      --panel: #0b2e18;
      --panel-light: #143b27;
      --panel-elevated: #16442d;
      --text: #e6f3ea;
      --text-muted: #9fcfaf;
      --accent: #10b981;
      --border: #0f381e;
      --code-bg: #071913;
      --gradient-bg: linear-gradient(135deg,#06220f 0%,#143b27 100%);
    }
    .theme-midnight {
      --bg: #0b1220;
      --panel: #0f1724;
      --panel-light: #141b2a;
      --panel-elevated: #181f32;
      --text: #e6eef8;
      --text-muted: #9fb3d6;
      --accent: #60a5fa;
      --border: #17202b;
      --code-bg: #071127;
      --gradient-bg: linear-gradient(135deg,#0b1220 0%,#141b2a 100%);
    }
    .theme-pastel {
      --bg: #fffaf6;
      --panel: #fff6f0;
      --panel-light: #fff1e9;
      --panel-elevated: #ffeee0;
      --text: #2b2b2b;
      --text-muted: #6b6b6b;
      --accent: #f472b6;
      --border: #f0dede;
      --code-bg: #fff6f2;
      --gradient-bg: linear-gradient(135deg,#fffaf6 0%,#fff1e9 100%);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--panel);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-dim);
    }
  </style>
  <!-- CodeMirror (simple editor for Go) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/go/go.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <img src="assets/logo.svg" alt="nanoGo">
        <span>nanoGo</span>
        <span class="brand-subtitle">Advanced WebAssembly Playground</span>
      </div>
      <div class="header-actions" style="position:relative">
        <button id="themeBtn" title="Choose theme">üåó</button>
        <div id="themePopup" class="theme-popup" aria-hidden="true">
          <div class="theme-popup-grid">
            <button class="theme-option" data-theme="dark">Dark</button>
            <button class="theme-option" data-theme="light">Light</button>
            <button class="theme-option" data-theme="solar">Solarized</button>
            <button class="theme-option" data-theme="dracula">Dracula</button>
            <button class="theme-option" data-theme="sepia">Sepia</button>
            <button class="theme-option" data-theme="monokai">Monokai</button>
            <button class="theme-option" data-theme="ocean">Ocean</button>
            <button class="theme-option" data-theme="forest">Forest</button>
            <button class="theme-option" data-theme="midnight">Midnight</button>
            <button class="theme-option" data-theme="pastel">Pastel</button>
            <button class="theme-option" data-theme="high-contrast">High Contrast</button>
          </div>
        </div>
        <button id="shareBtn" title="Share code">üì§ Share</button>
        <button id="downloadBtn" title="Download code">üíæ Download</button>
        <a href="https://github.com/SimonWaldherr/nanogo" target="_blank" style="color: var(--accent); text-decoration: none;">
          üìö GitHub
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="examples-panel">
        <div class="panel-header">
          üìö Examples & Demos
        </div>
        <input id="exampleSearch" class="example-search" placeholder="Search examples..." aria-label="Search examples" />
        <div id="tagFilters" style="padding: 0 1.25rem 0.5rem 1.25rem; display:flex; gap:6px; flex-wrap:wrap"></div>
        <div class="examples-list" id="examplesList">
          <!-- Examples will be populated by JavaScript -->
        </div>
      </div>

      <div class="info-panel">
        <h4 class="info-title">üí° Current Demo Info</h4>
        <div class="info-content" id="demoInfo">
          <p>Select an example to see detailed information about what it demonstrates.</p>
        </div>
      </div>
    </aside>

    <!-- Editor Section -->
    <section class="editor-section">
      <div class="editor-header">
        <h2 class="section-title">
          üìù Code Editor
        </h2>
        <div id="status" class="status loading">
          <div class="status-indicator"></div>
          Loading WebAssembly...
        </div>
      </div>

      <div class="controls">
        <button id="runBtn" class="primary" disabled>
          ‚ñ∂Ô∏è Run Code (Ctrl/‚åò+Enter)
        </button>
        <button id="stopBtn" title="Stop running program">‚èπÔ∏è Stop</button>
        <button id="clearBtn">üóëÔ∏è Clear</button>
        <div class="input-group">
          <label for="modeSelect">Mode:</label>
          <select id="modeSelect">
            <option value="stream">Stream</option>
            <option value="deferred">Deferred</option>
          </select>
        </div>
        <div class="input-group">
          <label for="scale">Canvas Scale:</label>
          <input id="scale" type="number" value="8" min="1" max="20">
        </div>
      </div>

      <div class="editor-container">
        <textarea id="src" spellcheck="false" placeholder="// Select an example from the sidebar to get started
// or write your own Go code here...

package main

import &quot;fmt&quot;

func main() {
    fmt.Println(&quot;Hello, nanoGo!&quot;)
}"></textarea>
  <!-- CodeMirror will replace the textarea above -->
      </div>
    </section>

    <!-- Output Section -->
    <section class="output-section">
      <!-- Canvas Output -->
      <div class="output-panel" id="canvasPanel">
        <div class="output-header">
          <span>üé® Canvas Output</span>
          <span class="example-badge">Visual</span>
        </div>
        <div class="output-content">
          <div class="canvas-container">
            <canvas id="life" width="320" height="240"></canvas>
          </div>
        </div>
      </div>

      <!-- Console Output -->
      <div class="output-panel active" id="consolePanel">
        <div class="output-header">
          <span>üìã Console Output</span>
          <span class="example-badge">Text</span>
        </div>
        <div class="output-content">
          <div id="log" tabindex="0" class="auto-scroll">Welcome to nanoGo!
Select an example from the sidebar to get started! üöÄ</div>
        </div>
      </div>

      <!-- DOM Output -->
      <div class="output-panel" id="domPanel">
        <div class="output-header">
          <span>üåê Template Output</span>
          <span class="example-badge">HTML</span>
        </div>
        <div class="output-content">
          <div id="output">
            <p style="color: var(--text-muted); font-style: italic;">
              HTML template outputs will appear here when running template demos.
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="wasm_exec.js"></script>
  <script src="examples.js"></script>
  <script>
    (function() {
      'use strict';

      // Example categorization with output types and descriptions
      const EXAMPLE_CONFIG = {
        'Basics': {
          output: 'console',
          description: 'Basic Go syntax, fmt package usage',
          badge: 'Fundamentals'
        },
        'Canvas': {
          output: 'canvas',
          description: 'Basic canvas drawing and pixel manipulation',
          badge: 'Graphics'
        },
        'Channels': {
          output: 'console',
          description: 'Go channels for concurrent communication',
          badge: 'Concurrency'
        },
        'WaitGroup': {
          output: 'console',
          description: 'Synchronization with sync.WaitGroup',
          badge: 'Concurrency'
        },
        'Regexp + JSON': {
          output: 'console',
          description: 'Regular expressions and JSON handling',
          badge: 'Data Processing'
        },
        'Strings/Sort': {
          output: 'console',
          description: 'String manipulation and sorting algorithms',
          badge: 'Utilities'
        },
        'Template + DOM': {
          output: 'dom',
          description: 'HTML template rendering to DOM elements',
          badge: 'Web'
        },
        'Random': {
          output: 'console',
          description: 'Random number generation with math/rand',
          badge: 'Math'
        },
        'Sleep': {
          output: 'console',
          description: 'Time delays and sleep functionality',
          badge: 'Time'
        },
        'Life': {
          output: 'canvas',
          description: 'Conway\'s Game of Life animation',
          badge: 'Simulation'
        },
        'HTTP + Storage': {
          output: 'dom',
          description: 'HTTP requests and localStorage usage',
          badge: 'Web APIs'
        }
        ,
        'FizzBuzz': { output: 'console', description: 'Classic FizzBuzz printing', badge: 'Algorithms' },
        'Fibonacci': { output: 'console', description: 'Recursive Fibonacci example', badge: 'Algorithms' },
        'Prime Sieve': { output: 'console', description: 'Sieve of Eratosthenes', badge: 'Algorithms' },
        'Checkerboard': { output: 'canvas', description: 'Simple checkerboard canvas demo', badge: 'Graphics' },
        'Bouncing Ball': { output: 'canvas', description: 'Animated bouncing pixel demo', badge: 'Animation' }
        , 'HTTP Fetch JSON': { output: 'console', description: 'Fetch text (CORS permitting) and display snippet', badge: 'Web' }
        , 'Pipeline': { output: 'console', description: 'Simple producer -> squarer pipeline using channels', badge: 'Concurrency' }
        , 'Structs & Methods': { output: 'console', description: 'Define structs and pointer vs value methods', badge: 'Types' }
        , 'Maps & Ranges': { output: 'console', description: 'Map creation and range iteration', badge: 'Utilities' }
        , 'Timer Ticker': { output: 'console', description: 'Timers and tickers for time-based events', badge: 'Time' }
        , 'JSON Roundtrip': { output: 'console', description: 'Marshal and unmarshal JSON', badge: 'Data' }
      };

      // Demo information content
      const DEMO_INFO = {
        'Basics': `
          <p><strong>Hello World Demo</strong></p>
          <p>Demonstrates basic Go program structure and the fmt package for output.</p>
          <ul>
            <li>Package declaration</li>
            <li>Import statements</li>
            <li>Main function</li>
            <li>Print statements</li>
          </ul>
        `,
        'Canvas': `
          <p><strong>Canvas Graphics Demo</strong></p>
          <p>Shows how to draw pixels on a canvas using browser-specific functions.</p>
          <ul>
            <li><code>browser.CanvasSize(w, h)</code> - Set canvas dimensions</li>
            <li><code>browser.CanvasSet(x, y, on)</code> - Set pixel state</li>
            <li><code>browser.CanvasFlush()</code> - Update display</li>
          </ul>
        `,
        'Channels': `
          <p><strong>Go Channels Demo</strong></p>
          <p>Demonstrates concurrent programming with channels for communication between goroutines.</p>
          <ul>
            <li>Channel creation with <code>make(chan type)</code></li>
            <li>Goroutine communication</li>
            <li>Channel closing and range loops</li>
          </ul>
        `,
        'WaitGroup': `
          <p><strong>Concurrency Synchronization</strong></p>
          <p>Uses sync.WaitGroup to coordinate multiple goroutines.</p>
          <ul>
            <li><code>wg.Add(1)</code> - Add goroutine to wait group</li>
            <li><code>wg.Done()</code> - Signal completion</li>
            <li><code>wg.Wait()</code> - Wait for all to finish</li>
          </ul>
        `,
        'Regexp + JSON': `
          <p><strong>Data Processing Demo</strong></p>
          <p>Combines regular expressions and JSON encoding/decoding.</p>
          <ul>
            <li>Regex pattern matching</li>
            <li>JSON marshalling</li>
            <li>String manipulation</li>
          </ul>
        `,
        'Strings/Sort': `
          <p><strong>String and Sorting Utilities</strong></p>
          <p>Demonstrates built-in string operations and sorting algorithms.</p>
          <ul>
            <li><code>strings.Split()</code> and <code>strings.Join()</code></li>
            <li><code>sort.Ints()</code> for integer sorting</li>
            <li>Slice manipulation</li>
          </ul>
        `,
        'Template + DOM': `
          <p><strong>HTML Template Rendering</strong></p>
          <p>Shows template rendering and DOM manipulation in the browser.</p>
          <ul>
            <li><code>template.RenderString()</code> - Render templates</li>
            <li><code>browser.SetHTML()</code> - Update DOM elements</li>
            <li>Data binding with maps and slices</li>
          </ul>
        `,
        'Random': `
          <p><strong>Random Number Generation</strong></p>
          <p>Demonstrates pseudorandom number generation with seeding.</p>
          <ul>
            <li><code>rand.Seed()</code> - Initialize generator</li>
            <li><code>rand.Intn()</code> - Generate random integers</li>
            <li>Reproducible randomness</li>
          </ul>
        `,
        'Sleep': `
          <p><strong>Time and Delays</strong></p>
          <p>Shows how to add delays and work with time in Go programs.</p>
          <ul>
            <li><code>time.Sleep()</code> - Add delays</li>
            <li>Non-blocking execution</li>
            <li>Time-based coordination</li>
          </ul>
        `,
        'Life': `
          <p><strong>Game of Life Simulation</strong></p>
          <p>Conway's Game of Life - a cellular automaton demonstrating complex behavior from simple rules.</p>
          <ul>
            <li>2D grid simulation</li>
            <li>Animation loops</li>
            <li>Cellular automaton rules</li>
            <li>Real-time canvas updates</li>
          </ul>
        `,
        'HTTP + Storage': `
          <p><strong>Web APIs Integration</strong></p>
          <p>Demonstrates HTTP requests and browser storage capabilities.</p>
          <ul>
            <li><code>http.GetText()</code> - Fetch text content</li>
            <li><code>storage.SetItem()</code> - Save to localStorage</li>
            <li>CORS and same-origin policies</li>
          </ul>
        `
        ,
        'FizzBuzz': `
          <p><strong>FizzBuzz</strong></p>
          <p>Classic programming warm-up that prints Fizz/Buzz for multiples of 3/5.</p>
        `,
        'Fibonacci': `
          <p><strong>Fibonacci</strong></p>
          <p>Recursive Fibonacci series calculation (small n to keep runtime reasonable).</p>
        `,
        'Prime Sieve': `
          <p><strong>Prime Sieve</strong></p>
          <p>Compute primes using the Sieve of Eratosthenes.</p>
        `,
        'Checkerboard': `
          <p><strong>Checkerboard</strong></p>
          <p>Draws a simple checkerboard pattern on the canvas using <code>browser.CanvasSet</code>.</p>
        `,
        'Bouncing Ball': `
          <p><strong>Bouncing Ball</strong></p>
          <p>Simple animated bouncing pixel to demonstrate canvas updates & timing.</p>
        `
        , 'HTTP Fetch JSON': `
          <p><strong>HTTP Fetch JSON</strong></p>
          <p>Fetch a text resource (examples.js) and display a short snippet ‚Äî subject to CORS.</p>
        `,
        'Pipeline': `
          <p><strong>Pipeline</strong></p>
          <p>Shows a simple pipeline with producer and squarer goroutines communicating over channels.</p>
        `,
        'Structs & Methods': `
          <p><strong>Structs & Methods</strong></p>
          <p>Demonstrates defining structs, String() method and pointer receivers.</p>
        `,
        'Maps & Ranges': `
          <p><strong>Maps & Ranges</strong></p>
          <p>Illustrates map creation, length and iterating with range.</p>
        `,
        'Timer Ticker': `
          <p><strong>Timer & Ticker</strong></p>
          <p>Demonstrates <code>time.NewTimer</code> and <code>time.NewTicker</code> usage for timed events.</p>
        `,
        'JSON Roundtrip': `
          <p><strong>JSON Roundtrip</strong></p>
          <p>Marshal a Go value to JSON and unmarshal it back.</p>
        `
      };

      // DOM elements
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const runBtn = document.getElementById("runBtn");
      const clearBtn = document.getElementById("clearBtn");
      const srcEl = document.getElementById("src");
      const scaleEl = document.getElementById("scale");
      const modeSelect = document.getElementById("modeSelect");
      const shareBtn = document.getElementById("shareBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const themeBtn = document.getElementById("themeBtn");
      const themePopup = document.getElementById("themePopup");
      const tagFilters = document.getElementById("tagFilters");
      const examplesList = document.getElementById("examplesList");
      const exampleSearch = document.getElementById("exampleSearch");
      const demoInfo = document.getElementById("demoInfo");

      const stopBtn = document.getElementById("stopBtn");

      // CodeMirror editor (initialized from the textarea)
      let editor = null;
      function initEditor() {
        if (typeof CodeMirror === 'undefined' || !srcEl) return;
        try {
          editor = CodeMirror.fromTextArea(srcEl, {
            mode: 'text/x-go',
            lineNumbers: true,
            theme: 'material',
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true
          });
          editor.setSize('100%', '100%');
        } catch (e) { editor = null; }
      }
      initEditor();

      function getSource() { return (editor && typeof editor.getValue === 'function') ? editor.getValue() : (srcEl ? srcEl.value : ''); }
      function setSource(v) { if (editor && typeof editor.setValue === 'function') editor.setValue(v); if (srcEl) srcEl.value = v; }

      // Output panels
      const canvasPanel = document.getElementById("canvasPanel");
      const consolePanel = document.getElementById("consolePanel");
      const domPanel = document.getElementById("domPanel");

      let worker = null;
      let currentExample = null;
      let selectedTag = null;
      let theme = (localStorage.getItem("nanogo_theme") || "dark");

      function setTheme(t) {
        theme = t || 'dark';
        // remove any existing theme-* classes to avoid leftover conflicts
        const cls = Array.from(document.documentElement.classList);
        cls.forEach(c => {
          if (c.startsWith('theme-')) document.documentElement.classList.remove(c);
        });
        // remove legacy 'light' marker
        document.documentElement.classList.remove('light');
        // apply new theme class (also keep 'light' for legacy light styles)
        if (theme === 'light') document.documentElement.classList.add('light');
        document.documentElement.classList.add('theme-' + (theme === 'light' ? 'light' : theme));
        localStorage.setItem("nanogo_theme", theme);
        // update button icon
        if (themeBtn) {
          const icons = { dark: 'üåó', light: 'üåô', solar: '‚òÄÔ∏è', dracula: 'üñ§', sepia: 'üü§', monokai: 'üü©', ocean: 'üåä', forest: 'üå≤', midnight: 'üåå', pastel: 'üå∏', 'high-contrast': '‚ö´' };
          themeBtn.textContent = icons[theme] || 'üé®';
        }
      }
      setTheme(theme);

      // Theme popup control
      function closeThemePopup() {
        if (!themePopup) return;
        themePopup.setAttribute('aria-hidden', 'true');
      }
      function openThemePopup() {
        if (!themePopup) return;
        themePopup.setAttribute('aria-hidden', 'false');
        // Sync aria-pressed with current theme and focus the selected option for accessibility
        try {
          const opts = themePopup.querySelectorAll('.theme-option');
          opts.forEach(o => o.setAttribute('aria-pressed', o.getAttribute('data-theme') === theme ? 'true' : 'false'));
          const sel = themePopup.querySelector('.theme-option[aria-pressed="true"]');
          if (sel) {
            sel.focus();
            sel.classList.add('focused');
            setTimeout(() => sel.classList.remove('focused'), 400);
          }
        } catch (e) { /* ignore */ }
      }
      if (themeBtn) themeBtn.onclick = (e) => {
        if (!themePopup) return;
        const hidden = themePopup.getAttribute('aria-hidden') !== 'false';
        if (hidden) openThemePopup(); else closeThemePopup();
      };

      // Wire theme option buttons and render swatches
      if (themePopup) {
        const THEME_META = {
          dark:    { bg: '#0a0c10', panel: '#111418', accent: '#3b82f6' },
          light:   { bg: '#ffffff', panel: '#f8fafc', accent: '#2563eb' },
          solar:   { bg: '#fdf6e3', panel: '#f6eedb', accent: '#b76e11' },
          dracula: { bg: '#282a36', panel: '#44475a', accent: '#ff79c6' },
          sepia:   { bg: '#f4ecd8', panel: '#efe6cf', accent: '#b76e11' },
          monokai: { bg: '#272822', panel: '#2b2b2b', accent: '#a6e22e' },
          ocean:   { bg: '#052f4a', panel: '#073848', accent: '#2dd4bf' },
          forest:  { bg: '#06220f', panel: '#0b2e18', accent: '#10b981' },
          midnight:{ bg: '#0b1220', panel: '#0f1724', accent: '#60a5fa' },
          pastel:  { bg: '#fffaf6', panel: '#fff6f0', accent: '#f472b6' },
          'high-contrast': { bg: '#000000', panel: '#000000', accent: '#ffff00' }
        };

        themePopup.querySelectorAll('.theme-option').forEach(btn => {
          const t = btn.getAttribute('data-theme');
          const meta = THEME_META[t] || THEME_META.dark;
          // render swatch + label
          btn.innerHTML = '';
          const sw = document.createElement('span');
          sw.className = 'swatch';
          sw.style.background = meta.bg;
          sw.style.borderColor = meta.accent;
          sw.title = t;
          const lbl = document.createElement('span');
          lbl.className = 'label';
          lbl.textContent = t.split('-').map(s=>s[0].toUpperCase()+s.slice(1)).join(' ');
          btn.appendChild(sw);
          btn.appendChild(lbl);

          // reflect current selection
          btn.setAttribute('aria-pressed', theme === t ? 'true' : 'false');

          btn.addEventListener('click', (ev) => {
            setTheme(t);
            // update aria-pressed on options
            themePopup.querySelectorAll('.theme-option').forEach(o => o.setAttribute('aria-pressed', 'false'));
            btn.setAttribute('aria-pressed', 'true');
            closeThemePopup();
          });
        });

        // click outside closes popup
        document.addEventListener('click', (ev) => {
          if (!themePopup) return;
          if (themePopup.getAttribute('aria-hidden') === 'false') {
            const path = ev.composedPath ? ev.composedPath() : (ev.path || []);
            if (!path.includes(themePopup) && ev.target !== themeBtn) closeThemePopup();
          }
        });
        // escape closes
        document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape') closeThemePopup(); });
      }

      if (exampleSearch) {
        exampleSearch.addEventListener('input', () => {
          fillExamples();
        });
      }

      function setStatus(message, type = "loading") {
        statusEl.className = `status ${type}`;
        statusEl.innerHTML = `<div class="status-indicator"></div>${message}`;
      }

      let logLines = [];
      let maxLogLines = 100;
      let fadeTimeout = 8000; // 8 seconds before starting to fade
      let isFocused = false;

      // Enhanced logging with fading and auto-scroll
      function logMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logLine = {
          text: `[${timestamp}] ${message}`,
          element: null,
          timestamp: Date.now()
        };

        // Create log line element
        const lineElement = document.createElement('div');
        lineElement.className = 'log-line';
        lineElement.textContent = logLine.text;
        logLine.element = lineElement;

        // Add to DOM
        logEl.appendChild(lineElement);
        logLines.push(logLine);

        // Remove old lines if too many
        if (logLines.length > maxLogLines) {
          const oldLine = logLines.shift();
          if (oldLine.element && oldLine.element.parentNode) {
            oldLine.element.parentNode.removeChild(oldLine.element);
          }
        }

        // Auto-scroll to bottom - force immediate scroll
        requestAnimationFrame(() => {
          logEl.scrollTop = logEl.scrollHeight;
          // Double-check scroll in case content is still loading
          setTimeout(() => {
            logEl.scrollTop = logEl.scrollHeight;
          }, 50);
        });

        // Start fade timer if not focused
        if (!isFocused) {
          setTimeout(() => startFading(logLine), fadeTimeout);
        }

        // Update existing lines fade status
        updateLogLinesFading();
      }

      function updateLogLinesFading() {
        if (isFocused) return;

        const now = Date.now();
        logLines.forEach(line => {
          if (!line.element) return;
          
          const age = now - line.timestamp;
          if (age > fadeTimeout * 2) {
            line.element.className = 'log-line old';
          } else if (age > fadeTimeout) {
            line.element.className = 'log-line fading';
          } else {
            line.element.className = 'log-line';
          }
        });
      }

      function startFading(logLine) {
        if (isFocused || !logLine.element) return;
        
        const age = Date.now() - logLine.timestamp;
        if (age >= fadeTimeout) {
          logLine.element.className = 'log-line fading';
          
          // Further fade after another interval
          setTimeout(() => {
            if (!isFocused && logLine.element) {
              logLine.element.className = 'log-line old';
            }
          }, fadeTimeout);
        }
      }

      function clearLog() {
        logEl.innerHTML = "";
        logLines = [];
        
        // Add initial message
        const initialLine = document.createElement('div');
        initialLine.className = 'log-line';
        initialLine.textContent = "üéØ Output cleared. Ready for new execution!";
        logEl.appendChild(initialLine);
        
        logLines.push({
          text: "üéØ Output cleared. Ready for new execution!",
          element: initialLine,
          timestamp: Date.now()
        });

        // Force scroll to bottom after clearing
        setTimeout(() => {
          logEl.scrollTop = logEl.scrollHeight;
        }, 50);

        const c = document.getElementById('life');
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, c.width, c.height);
        document.getElementById('output').innerHTML = '<p style="color: var(--text-muted); font-style: italic;">Output will appear here...</p>';
      }

      // Focus management for console
      logEl.addEventListener('focus', () => {
        isFocused = true;
        logEl.classList.add('focused');
        // Restore all lines to full opacity
        logLines.forEach(line => {
          if (line.element) {
            line.element.className = 'log-line';
          }
        });
      });

      logEl.addEventListener('blur', () => {
        isFocused = false;
        logEl.classList.remove('focused');
        // Restart fading process
        setTimeout(updateLogLinesFading, 100);
      });

      // Update fading periodically
      setInterval(() => {
        if (!isFocused) {
          updateLogLinesFading();
        }
      }, 1000);
      clearBtn.onclick = clearLog;

      function showOutputPanel(type) {
        // Hide all panels
        canvasPanel.classList.remove('active');
        consolePanel.classList.remove('active');
        domPanel.classList.remove('active');

        // Show the appropriate panel
        switch (type) {
          case 'canvas':
            canvasPanel.classList.add('active');
            break;
          case 'dom':
            domPanel.classList.add('active');
            break;
          default:
            consolePanel.classList.add('active');
        }
      }

      function drawCell(x, y, alive) {
        const canvas = document.getElementById('life');
        const ctx = canvas.getContext('2d');
        const cs = parseInt(scaleEl.value, 10) || 8;
        ctx.fillStyle = alive ? '#10b981' : '#0d1117';
        ctx.fillRect(x * cs, y * cs, cs, cs);
      }

      function startWasmWorker() {
        if (worker) return;
        
        if (location.protocol === 'file:') {
          setStatus("Error: Must run on HTTP server, not file://", "error");
          logMessage("ERROR: WebAssembly requires HTTP/HTTPS protocol.");
          logMessage("Start a local server: python3 -m http.server 8080");
          return;
        }

        worker = new Worker('wasm_worker.js');
        worker.onmessage = (ev) => {
          const m = ev.data;
          if (!m || !m.type) return;
          switch (m.type) {
            case 'ready':
              setStatus('Ready', 'ready');
              runBtn.disabled = false;
              logMessage('üéâ WebAssembly loaded and ready!');
              fillExamples();
              loadCodeFromURL();
              break;
            case 'log':
              logMessage(String(m.text));
              break;
            case 'warn':
              logMessage('‚ö†Ô∏è WARN: ' + String(m.text));
              break;
            case 'error':
              logMessage('‚ùå ERROR: ' + String(m.text));
              setStatus('Runtime error', 'error');
              break;
            case 'canvas-size': {
              const w = Number(m.w), h = Number(m.h);
              const scale = parseInt(scaleEl.value, 10);
              const canvas = document.getElementById('life');
              canvas.width = w * scale;
              canvas.height = h * scale;
              break;
            }
            case 'canvas-set': {
              const cx = Number(m.x), cy = Number(m.y), alive = !!m.alive;
              drawCell(cx, cy, alive);
              break;
            }
            case 'canvas-flush':
              break;
            case 'dom-setinner': {
              const el = document.getElementById(m.id);
              if (el) el.innerHTML = m.html;
              logMessage('üìÑ HTML template rendered');
              break;
            }
            case 'dom-setvalue': {
              const elv = document.getElementById(m.id);
              if (elv) elv.value = m.value;
              break;
            }
            case 'dom-addclass': {
              const ea = document.getElementById(m.id);
              if (ea) ea.classList.add(m.class);
              break;
            }
            case 'dom-removeclass': {
              const er = document.getElementById(m.id);
              if (er) er.classList.remove(m.class);
              break;
            }
            case 'open-window': {
              try { window.open(m.url, '_blank') } catch (e) { console.warn(e) }
              break;
            }
            case 'alert': {
              try { window.alert(m.text) } catch (e) { console.warn(e) }
              break;
            }
            case 'done':
              logMessage('‚úÖ === Execution finished ===');
              setStatus('Ready', 'ready');
              break;
            default:
              console.log('worker:', m);
          }
        };
        worker.onerror = (e) => {
          setStatus('Worker error', 'error');
          logMessage('‚ùå Worker error: ' + e.message);
        };
        worker.postMessage({ type: 'init' });
      }

      function runCode() {
        try {
          if (!worker) throw new Error('worker not initialized');
          
          // Show appropriate output panel for current example
          if (currentExample && EXAMPLE_CONFIG[currentExample]) {
            showOutputPanel(EXAMPLE_CONFIG[currentExample].output);
          }
          
          const scale = parseInt(scaleEl.value, 10);
          worker.postMessage({ type: 'set-scale', scale: scale });
          
          const c = document.getElementById('life');
          const ctx = c.getContext('2d');
          ctx.clearRect(0, 0, c.width, c.height);
          
          localStorage.setItem("nanogo_last", getSource());
          logMessage('üöÄ === Running user code ===');
          setStatus('Running code...', 'loading');
          const mode = modeSelect.value || 'stream';
          const t0 = performance.now();
          worker.postMessage({ type: 'run', source: getSource(), mode: mode, t0 });
        } catch (err) {
          setStatus('Runtime error', 'error');
          logMessage('‚ùå RUNTIME ERROR: ' + err.message);
        }
      }

      runBtn.onclick = runCode;

      if (stopBtn) {
        stopBtn.onclick = () => {
          if (!worker) { logMessage('No worker running'); return; }
          try {
            worker.terminate();
          } catch (e) {}
          worker = null;
          setStatus('Stopped', 'error');
          logMessage('‚õî Execution terminated by user');
          // Reinitialize the worker so user can run again quickly
          setTimeout(() => startWasmWorker(), 300);
        };
      }

      function fillExamples() {
        // Ensure tag filters are rendered once
        function renderTagFilters() {
          if (!tagFilters) return;
          if (tagFilters.dataset.inited) return;
          // collect unique badges
          const tags = new Set();
          Object.keys(EXAMPLE_CONFIG).forEach(k => { if (EXAMPLES[k]) tags.add(EXAMPLE_CONFIG[k].badge || 'Demo'); });
          // Clear and add 'All'
          tagFilters.innerHTML = '';
          const allBtn = document.createElement('button');
          allBtn.className = 'tag-btn' + (selectedTag ? '' : ' active');
          allBtn.textContent = 'All';
          allBtn.onclick = () => { selectedTag = null; document.querySelectorAll('.tag-btn').forEach(b=>b.classList.remove('active')); allBtn.classList.add('active'); fillExamples(); };
          tagFilters.appendChild(allBtn);
          tags.forEach(t => {
            const b = document.createElement('button');
            b.className = 'tag-btn' + (selectedTag === t ? ' active' : '');
            b.textContent = t;
            b.onclick = () => { selectedTag = (selectedTag === t ? null : t); document.querySelectorAll('.tag-btn').forEach(btn=>btn.classList.remove('active')); if (selectedTag) b.classList.add('active'); else allBtn.classList.add('active'); fillExamples(); };
            tagFilters.appendChild(b);
          });
          tagFilters.dataset.inited = '1';
        }

        examplesList.innerHTML = "";
        renderTagFilters();
        const filter = exampleSearch && exampleSearch.value ? exampleSearch.value.trim().toLowerCase() : "";

        Object.keys(EXAMPLES).forEach(name => {
          if (name === 'Empty') return; // Skip empty example
          const config = EXAMPLE_CONFIG[name] || { output: 'console', description: 'Go programming example', badge: 'Demo' };

          // Filter by name or description
          if (filter) {
            const hay = (name + ' ' + (config.description || '')).toLowerCase();
            if (!hay.includes(filter)) return;
          }
          // Filter by selected tag
          if (selectedTag && config.badge !== selectedTag) return;

          const item = document.createElement('div');
          item.className = 'example-item';
          item.tabIndex = 0;
          item.onclick = () => selectExample(name);
          item.onkeypress = (e) => { if (e.key === 'Enter') selectExample(name); };

          const info = document.createElement('div');
          info.className = 'example-info';
          info.innerHTML = `<div class="example-name">${name}</div><div class="example-desc">${config.description}</div>`;

          const badge = document.createElement('div');
          badge.className = 'example-badge';
          badge.textContent = config.badge;

          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-btn';
          copyBtn.title = 'Copy example code';
          copyBtn.textContent = 'Copy';
          copyBtn.onclick = (ev) => {
            ev.stopPropagation();
            navigator.clipboard.writeText(EXAMPLES[name]).then(() => {
              copyBtn.textContent = 'Copied!';
              setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1500);
            }, () => {
              copyBtn.textContent = 'Failed';
              setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1500);
            });
          };

          const rightCol = document.createElement('div');
          rightCol.style.display = 'flex';
          rightCol.style.gap = '8px';
          rightCol.style.alignItems = 'center';
          rightCol.appendChild(badge);
          rightCol.appendChild(copyBtn);

          item.appendChild(info);
          item.appendChild(rightCol);

          examplesList.appendChild(item);
        });

        // Initialize enhanced logging (only once on first fill)
        if (!logLines || logLines.length === 0) initializeEnhancedLogging();

        // Auto-select first example when nothing is selected and filter yields items
        const any = examplesList.querySelector('.example-item');
        if (any && !currentExample) {
          const firstNameEl = any.querySelector('.example-name');
          if (firstNameEl) selectExample(firstNameEl.textContent);
        }
      }

      function initializeEnhancedLogging() {
        // Clear and setup initial log
        logEl.innerHTML = "";
        logLines = [];
        
        // Create initial welcome message
        const welcomeLines = [
          "Welcome to nanoGo!",
          "Select an example from the sidebar to get started!",
          ""
        ];

        welcomeLines.forEach(text => {
          const lineElement = document.createElement('div');
          lineElement.className = 'log-line';
          lineElement.textContent = text;
          logEl.appendChild(lineElement);
          
          logLines.push({
            text: text,
            element: lineElement,
            timestamp: Date.now()
          });
        });

        // Ensure initial scroll to bottom
        setTimeout(() => {
          logEl.scrollTop = logEl.scrollHeight;
        }, 100);
      }

      function selectExample(name) {
        if (!EXAMPLES[name]) return;
        
        currentExample = name;
        setSource(EXAMPLES[name]);

        // Update active state
        document.querySelectorAll('.example-item').forEach(item => {
          item.classList.remove('active');
        });
        
        const activeItem = Array.from(document.querySelectorAll('.example-item')).find(
          item => item.querySelector('.example-name').textContent === name
        );
        if (activeItem) activeItem.classList.add('active');

        // Update demo info
        demoInfo.innerHTML = DEMO_INFO[name] || '<p>No additional information available.</p>';

        // Show appropriate output panel
        const config = EXAMPLE_CONFIG[name] || { output: 'console' };
        showOutputPanel(config.output);

        logMessage(`üìñ Loaded example: ${name} (${config.output} output)`);
      }

      // Share functionality
      shareBtn.onclick = () => {
        const b64 = btoa(unescape(encodeURIComponent(getSource())));
        const url = location.origin + location.pathname + "#code=" + b64;
        navigator.clipboard.writeText(url).then(() => {
          setStatus("Share URL copied!", "ready");
          logMessage("üì§ Share URL copied to clipboard");
          shareBtn.textContent = '‚úÖ Copied!';
          setTimeout(() => shareBtn.textContent = 'üì§ Share', 2000);
        }, err => {
          logMessage("‚ùå Share copy failed: " + err);
        });
      };

      // Download functionality
      downloadBtn.onclick = () => {
        const blob = new Blob([getSource()], { type: "text/plain" });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "nanogo-pro-code.go";
        a.click();
        URL.revokeObjectURL(a.href);
        logMessage("üíæ Code downloaded");
      };

      function loadCodeFromURL() {
        const hash = location.hash.startsWith("#code=") ? location.hash.slice(6) : "";
        if (hash) {
          try {
            setSource(atob(decodeURIComponent(hash)));
            logMessage("üì• Code loaded from URL");
            showOutputPanel('console'); // Default to console for shared code
          } catch (e) {
            logMessage("‚ùå Failed to load code from URL");
          }
        } else {
          const saved = localStorage.getItem("nanogo_last");
          if (saved && saved !== EXAMPLES['Basics']) {
            setSource(saved);
            logMessage("üíæ Restored previous session");
            showOutputPanel('console');
          }
        }
      }

      // Keyboard shortcuts
      window.addEventListener('keydown', (ev) => {
        if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') {
          runCode();
          ev.preventDefault();
        }
      });

      // Initialize
      setStatus('Loading WebAssembly...', 'loading');
      startWasmWorker();
    })();
  </script>
</body>
</html>